steps:
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    # Define variables
    GITHUB_REPO="https://github.com/Anand2106/GCP_Repo.git"
    BRANCH_NAME="gcp_deployement"
    COMMIT_MESSAGE="Update queries from BigQuery"
    ACCESS_TOKEN="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"

    # Write service account key to a file
    echo "${SERVICE_ACCOUNT_KEY}" > /service-account-key.json

    # Authenticate with the service account
    gcloud auth activate-service-account --key-file=/service-account-key.json

    # Set project
    gcloud config set project ringed-hallway-427106-i4

    # Retrieve query job history
    bq ls --jobs --filter="state=SUCCESS" --format=prettyjson > jobs.json

    # Extract SQL queries from the job history
    jq -r '.[] | select(.configuration.query != null) | .configuration.query.query' jobs.json > queries.sql

    # Clone the GitHub repository
    git config --global user.email "anandpandian7397@gmail.com"
    git config --global user.name "Anand2106"
    git clone https://${ACCESS_TOKEN}@github.com/Anand2106/GCP_Repo.git
    cd GCP_Repo

    # Move the queries file to the repository
    mv ../queries.sql .

    # Commit and push the changes
    git add queries.sql
    git commit -m "${COMMIT_MESSAGE}"
    git push origin ${BRANCH_NAME}

timeout: 900s

options:
  logging: CLOUD_LOGGING_ONLY

secretEnv:
  SERVICE_ACCOUNT_KEY: projects/ringed-hallway-427106/secrets/my-service-account-key/versions/latest
